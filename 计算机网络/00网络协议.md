# 00 网络协议

## 基本概念

### 网络协议

网络互联模型：

> **OSI参考模型**	| **TCP/IP协议** 	| **学习研究**   	  |
>
> 7 应用层		   | 4 应用层		  |						  |
>
> 6 表示层		   |						  |						  |
>
> 5 会话层		   |						  | 5 应用层		  |
>
> 4 运输层 	      | 3 运输层		  | 4 运输层 	      | 
>
> 3 网络层           | 2 网际层 		 | 3 网络层           |
>
> 2 数据链路层   | 1 网络接口层  | 2 数据链路层    | 
>
> 1 物理层  		 |						 | 1 物理层  	 	 |  	



## 网络层

* 网络层数据包（IP数据包、Packet）由首部、数据2部分组成
* 数据：很多时候是由传输层传递下来的数据段（Segment）

首部固定部分20个字节，版本4位，首部长度4位，区分服务8位，总长度16位；标识16位，标志加片偏移16位；生存时间8位；协议8位，首部检验和8位；源IP地址32位；目的IP地址32位。

剩下为可选字段（长度可变）加填充部分。

> 数据链路层的帧数据不能超过1500字节，过大的IP数据包需要分成片（fragments）传输给数据链路层，且每一片都有自己的网阔层首部（IP首部）。

**版本**：IPv4或IPv6.

**首部长度**：首部长度乘4即为首部实际长度。

**区分服务**：可以提高网络的服务质量。

**总长度**：4个字节，首部+数据长度之和，范围0-65535。

**标识**：数据包过大分片时，同一个数据包的标识都是一样的。

**标志和片偏移**：标志3位，保留位，不分片位，更多片位。片偏移13位，数值乘8得到字节偏移量，每一片的长度都是8的整数倍。

**生存时间**：TTL，路由器跳数，每次转发减1，减到0丢弃，返回错误报告。

**协议**：表明封装的数据是什么协议。

**首部校验和**：计算首部数据完整性。



* TCP（Transmission Control Protocol），传输控制协议。
* UDP（User Datagram Protocol），用户数据报协议。

|            |             TCP             |       UDP        |
| :--------: | :-------------------------: | :--------------: |
|   连接性   |          面向连接           |      无连接      |
|   可靠性   |          可靠传输           |    不可靠传输    |
|  首部占用  |             大              |        小        |
|  传输速率  |             慢              |        快        |
|  资源消耗  |             大              |        小        |
|  应用场景  | 浏览器、文件传输、邮件发送  | 音视频通话、直播 |
| 应用层协议 | HTTP、HTTPS、FTP、SMTP、DNS |       DNS        |

## UDP

* UDP是无连接的，减少了建立和释放连接的开销。
* UDP尽最大能力交付，不保证可靠交付
* UDP不需要维护一些复杂的参数，首部只有8个字节（TCP首部至少20个字节）。

> UDP协议头中的长度表示整个报文的长度。
>
> UDP检验和是计算伪首部（12个字节）+首部+数据。

端口

> * UDP首部中的端口是占用2字节：0-65535。
> * 客户端的源端口是临时开启的随机端口。
>
> HTTP：TCP+80
>
> HTTPS：TCP+443
>
> FTP：TCP+21
>
> MySQL：TCP+3306
>
> DNS：UDP/TCP+53
>
> SMTP：TCP+25
>
> POP3：TCP+110



## TCP

### TCP数据格式

TCP首部至少20个字节，20个字节固定首部+可变部分；

固定首部：

* 源端口（8位）：源端口。
* 目的端口（8位）：目的端口。
* 序号（16位）：4个字节，（传输过程）序号代表这一次传给对方的TCP数据部分的第一个字节的编号。
* 确认号（16位）：4个字节，（传输过程）期望下一次传输的数据的第一个字节的编号。
* 数据偏移（4位）：乘以4后为首部长度（固定20字节+可变长度）。
* 保留位（6位）：全部为0。
* URG、ACK、PSH、RST、SYN、FIN

> URG：当URG=1时，紧急指针字段才有效，应优先尽快传递。
>
> ACK：当ACK=1时确认字段有意义。
>
> PSH：一般用不上。
>
> RST：当RST=1时，表名连接中出现验证差错，必须释放连接，然后重新建立连接。
>
> SYN：SYN=1,ACK=0时表名时建立连接请求；
>
> FIN：FIN=1，表示要求释放连接。

* 窗口（8位）：流量控制，窗口大小。
* 检验和（16位）：两个字节，计算方法同UDP，伪首部+首部+数据。
* 紧急指针（16位）：当URG=1时，一般这里放长度，代表数据段前xx字节长度的数据比较重要。



### TCP可靠传输

#### 停止等待ARQ协议

* ARQ（Automatic Repeat-reQuest），自动重传请求。

TCP可靠传输采用连续ARQ协议+窗口滑动协议，每次发送窗口大小数据，只发送最后收到的有效数据的确认序号，代表之前的数据都收到了。发送端的窗口是由接收端决定的。

SACK是一种选择重传的技术，下面是传统的重传技术：

> * 在TCP通信中，如果发送序列中某个数据报丢失（比如1、2、3、4、5中丢失3）
> * TCP会通过重传最后确认的分组后续的分组（最后确认的是2，会重传3、4、5）
> * 这样原先已经正确传输的分组也可能重复发送（比如4、5）降低了TCP的性能。

为了改善上述情况发展出了SACK技术。可以告诉发送方那些丢失那些收到。实现部分在TCP头部的选项（可变长度）部分。





### TCP流量控制



### TCP拥塞控制











